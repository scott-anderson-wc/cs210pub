<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS110: Emailing a Form, Formatted</title>
    <!--#include virtual="../../../modularity/bs-head.part" -->
    <link rel="stylesheet" type="text/css" href="http://cs.wellesley.edu/~cs307/js/google-code-prettify/prettify-sda.css">
    <script src="http://google-code-prettify.googlecode.com/svn/loader/prettify.js"></script>
    <style>
      #TOC_list {list-style-type: none;}

      form, #email_body {
             margin: 3ex 1em;
             border: 3px double black;
             background-color: #eee;
             padding: 3ex 1em;
           }

      form {
             border: 3px double black;
           }

      #email_body {
             border: 2px solid #2e9ad3;
           }

    .ok {  font-size: normalsize; color: green; }
    .failed { font-size: bigger; color: red; }
    </style>
    
  </head>
  <body>
    <!--#include virtual="../../../modularity/navbar.part" -->

    <div class="container">
      <h1>Emailing a Form, Formatted</h1>
      <hr>
    </div>
      
    <div class="container">
      <div class="row">
     
        <div class="col-md-3">
          <div class="bs-sidebar hidden-print" role="complementary">
            <ul class="nav bs-sidenav">  
              <div id="insert_TOC_here"></div>
            </ul>
          </div>
        </div>

        <div class="col-md-8">

<p>The goal here is to be able to put a special-purpose form on a website,
  such as allowing people to make suggestions, order merchandise, or
  express preferences.  Submitting that form causes the data to be sent in
  an email to someone in your organization whose job is to handle them.

<p>We'll even do allow the form data to be nicely formatted, using
  techniques like the madlibs we did much earlier.  We can also do the
  form submission using Ajax.

<p>The basic idea here involves the following steps:
  <ul>
    <li>Create the form.
      
    <li>Create a template for the formatted data.
      
    <li>Have a button that submits the form.

    <li>The button invokes an event handler that copies the data into a
    template.  In this example, the template will be visible, but in
    general it could be hidden.
      
    <li>Once the data is filled in, the template's contents are made the
      body of an email message and sent using Ajax.
  </ul>

<h2>Example Form</h2>

<p>Here's our example form:

  <form id="pizza_form" method="post"
         action="/~cs110/php/mailto_gdome_at_cs_wellesley_edu.php">
 <p><label>Customer name: <input name="customer"></label></p>
 <p><label>Telephone: <input type=tel name="phone"></label></p>
 <p><label>E-mail address: <input type=email name="addr"></label></p>
 <fieldset>
  <legend> Pizza Size </legend>
  <p><label> <input type=radio name="size" value="small"> Small </label></p>
  <p><label> <input type=radio name="size" value="medium"> Medium </label></p>
  <p><label> <input type=radio name="size" value="large"> Large </label></p>
 </fieldset>
 <fieldset>
  <legend> Pizza Toppings </legend>
  <p><label> <input type=checkbox name="tops" value="bacon"> Bacon </label></p>
  <p><label> <input type=checkbox name="tops" value="cheese"> Extra Cheese </label></p>
  <p><label> <input type=checkbox name="tops" value="onion"> Onion </label></p>
  <p><label> <input type=checkbox name="tops" value="mushroom"> Mushroom </label></p>
 </fieldset>
 <p><label>Preferred delivery time:
     <input name="due" type=time min="11:00" max="21:00" step="900">
    </label></p>
 <p><label>Delivery instructions:
     <textarea name="instructions"></textarea>
 </label></p>
 <p><button id="format_button" type="button">Just format</button></p>
 <p><button id="submit_button" type="button">Submit order</button></p>
</form>

<p>The response is here:
<p id="order_response"></p>

<h2>Template</h2>

<p>Here's the email message we want to send:

<div id="email_body">
  <p>My name is <span class="customer">CUSTOMER</span> and my phone number
     is <span class="phone">PHONE</span>.
     Email address is <span class="addr">EMAIL</span>.

     
  <p>I would like a <span class="size">SIZE</span> pizza,
  with <span class="tops">TOPPINGS</span>.

  <p>Please deliver it at <span class="due">DUE</span> via
  <p class="instructions">DELIVERY INSTRUCTIONS</p>

</div>

<h2>Format Message</h2>

<p>Let's start with the code to format the message:

<pre id="pre_format_message" class="prettyprint lang-js linenums"></pre>

<p>Most of the code is pretty straightforward, but checkboxes are tricky
  because multiple selections are possible. To handle that, don't use
  the <code>.val()</code> method.  Instead, we select the checked boxes,
  which returns an <em>array</em> of the matched elements. We then process
  that array using the function <code>checked_values</code>.

<p>The <code>checked_values</code> function goes through the array,
  collecting their values.  It then uses a built-in method for arrays
  called <code>.join</code>, which converts an array into a string,
  splicing the given connector (in this case, a comma) between the
  elements.

<h2>Sending Mail</h2>

<p>Our next step is to take the HTML of the formatted message and make it
  the <em>body</em> of an email message. Remember that our back-end PHP
  script wants up to <em>four</em> pieces of information:
  <ul>
    <li>from_name
      
    <li>from_email
      
    <li>subject
      
    <li>body
  </ul>
  <P>We can give default values for any of these when we create the
  back-end script, but we can also provide them when the actual email is
  sent.

  <p>We do that by creating a JavaScript <em>object</em>.  For example, we
  could do the following:

<pre>
var msg = {from_name: "Barack Obama",
           from_email: "president@whitehouse.gov",
           subject: "state of the union",
           body: "The union is perfect. Here's my plan to make it more perfect."};
</pre>    

<p>Of course, we'll do something more prosaic, like a pizza order, so we
  might say something like this:

<pre>
var msg = {from_name:  $("#pizza_form [name=from_name]").val(),
           from_email: $("#pizza_form [name=from_email]").val(),
           subject: "pizza order",
           body: $("#email_body").html()}
</pre>    

<p>Notice that we can make the body of the email be the HTML of our
  formatted message.

<p>The next step is to send the email, using the
  jQuery <code>.post()</code> method:

<pre class="prettyprint lang-js linenums">
$.post("url of our backend script",
       msg,
       function (response) {
         alert("response status is "+response.status);
       }
       "json");
</pre>  
  
<p>Let's put this all together into our finished pizza order form

<pre id="pre_email_order" class="prettyprint lang-js linenums"></pre>
        
      </div><!-- end of row -->
    </div><!-- end of class=container -->

    <!--#include virtual="../../../modularity/bs-footer.part" -->
    <script src="../../../js/TOC.js"></script>
    <script>insertTOC_textual(); </script>

<script id="script_format_message">
// copies all data from the form to the #email_body. 
function format_message() {
    $("#email_body .customer").text( $("#pizza_form [name=customer]").val() );
    $("#email_body .phone").text( $("#pizza_form [name=phone]").val() );
    $("#email_body .addr").text( $("#pizza_form [name=addr]").val() );
    $("#email_body .size").text( $("#pizza_form [name=size]").val() );
    $("#email_body .tops").text( checked_values($("#pizza_form [name=tops]:checked")) );
    $("#email_body .due").text( $("#pizza_form [name=due]").val() );
    $("#email_body .instructions").text( $("#pizza_form [name=instructions]").val() );
 }

// function that takes a jQuery wrapped set (an array) of elements and
// returns a string that joins all their value attributes.

function checked_values(jq_set) {
    var len = jq_set.length; vals = [];
    for( var i = 0 ; i < len; i++ ) {
        var input_elt = jq_set[i];
        vals.push( input_elt.value );
    }
    return vals.join(",");
}

$("#format_button").click(format_message);
</script>

<script id="script_email_order">
function email_order() {
    format_message();
    var msg = {from_name:  $("#pizza_form [name=customer]").val(),
               from_email: $("#pizza_form [name=addr]").val(),
               subject: "pizza order",
               body: $("#email_body").html()}
    $.post( $("#pizza_form").attr("action"),
       msg,
       function (response) {
           console.log(response.status);
           if(response.status == "ok") {
               $("#order_response")
                   .html("Your order was sent")
                   .addClass("ok");
           } else {
               $("#order_response")
                   .html("Your order was <em>not</em> sent")
                   .addClass("failed");
           }
       },
       "json");
}

$("#submit_button").click(email_order);
</script>


    <script src="/~cs307/js/google-code-prettify/prettify.js"></script>

<script>
  // Copies the script code to the PRE element
    $("#pre_format_message").text( $("#script_format_message").text() );
    $("#pre_email_order").text( $("#script_email_order").text() );

  // finally, pretty-print.
  prettyPrint();
</script>

   </div>
  </div>
  <!--#include virtual="../../../modularity/footer.part" -->
 </div> <!--end of container -->
        
</body>
</html>
